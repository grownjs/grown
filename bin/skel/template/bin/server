#!/bin/sh

':' // ; exec "$(command -v nodejs || command -v node)" "$0" "$@"
;

'use strict';

process.stdout.write('Loading server...\r');

const app = require('../app/server');

function runApplication() {
  const farm = app();

  process.stdout.write('Starting framework...\r');

  farm.emit('start').then(() =>
    farm.listen(process.env.PORT || 8080, $ => {
      process.stdout.write(`Listening on ${$.location.href}\n`);
    }).catch(error => {
      process.stderr.write(`${error.toString()}\n`);
      process.exit(1);
    }));

  return () => app.teardown();
}

if (require.main === module) {
  runApplication();
}

module.exports = () => runApplication();

process.on('SIGINT', () => app.teardown(() => process.exit()));
