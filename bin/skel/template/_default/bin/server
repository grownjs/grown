#!/bin/sh

':' // ; exec "$(command -v nodejs || command -v node)" "$0" "$@"
;

'use strict';

let _farm;

function runApplication() {
  let _closing;

  process.stdout.write('Loading server...\r');

  function close(cb) {
    _closing = true;

    return _farm.stop(() => {
      _closing = false;

      if (cb) {
        cb();
      }
    });
  }

  function main() {
    const bootstrap = require('../{{APPLICATION}}');

    process.stdout.write('Starting framework...\r');

    _farm = bootstrap();

    _farm.on('reload', () => {
      if (!_closing) {
        close(() => setTimeout(runApplication, 100));
      }
    });

    return Promise.resolve()
      .then(() => _farm.run(() => _farm.listen(process.env.PORT || 8080)))
      .then(app => {
        process.stdout.write(`Listening on ${app.location.href} (grown-v${bootstrap.version}) [press CTRL-C to quit]\n`);
      })
      .catch(error => {
        process.stderr.write(`${error.stack}\n`);

        if (require.main === module) {
          process.exit(1);
        }
      });
  }

  if (!_closing) {
    main();
  } else {
    process.stdout.write('Closing previous instance...\r');
    setTimeout(runApplication, 100);
  }

  return close;
}

if (require.main === module) {
  runApplication();
}

module.exports = () => runApplication();
