#!/bin/sh

':' // ; exec "$(command -v nodejs || command -v node)" "$0" "$@"
;

'use strict';

let _closing;

const bootstrap = require('../lib/{{paramCase APP_NAME}}/application');

process.stdout.write('Loading server...\r');

function runApplication() {
  function main() {
    process.stdout.write('Starting framework...\r');

    const farm = bootstrap();

    return farm.run(() => farm.listen(process.env.PORT || '8080'))
      .then(app => {
        process.stdout.write(`Listening on ${app.location.href} [press CTRL-C to quit]\n`);
      })
      .catch(error => {
        process.stderr.write(`${error.toString()}\n`);

        if (require.main === module) {
          process.exit(1);
        }
      });
  }

  if (!_closing) {
    main();
  } else {
    process.stdout.write('Closing previous instance...\r');
    setTimeout(runApplication, 100);
  }

  return () => {
    _closing = true;

    return bootstrap.teardown(() => {
      _closing = false;
    });
  };
}

if (require.main === module) {
  runApplication();
}

module.exports = () => runApplication();
