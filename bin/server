#!/bin/sh
':' // ; exec "$(command -v nodejs || command -v node)" "$0" "$@"
;

'use strict';

/* eslint-disable global-require */
/* eslint-disable prefer-rest-params */

process.env.IS_REPL = process.argv.indexOf('--repl') > -1;
process.env.NODE_ENV = process.env.NODE_ENV || 'dev';

/* istanbul ignore else */
if (process.argv.indexOf('--debug') > -1) {
  require('debug').enable('homegrown,homegrown:*');
}

/* istanbul ignore else */
if (process.env.NODE_ENV === 'dev') {
  require('source-map-support').install();
}

// common helpers
const die = statusCode => process.exit(statusCode);

// standard output
function echo() {
  process.stdout.write(`${Array.prototype.slice.call(arguments).join('')}`);
}

// runtime hooks
const Module = require('module');

function _clearModules() {
  Object.keys(Module._cache)
    .forEach((key) => {
      /* istanbul ignore else */
      if (key.indexOf('node_modules') === -1) {
        delete Module._cache[key];
      }
    });
}

// initialization
let $;

const cwd = process.cwd();
const path = require('path');

const homegrown = require('..');

// setup environment
homegrown.env(cwd);

function parseBool(value) {
  if (value === 'true') {
    return true;
  }

  if (value === 'false') {
    return false;
  }

  return undefined;
}

function _startServer(done) {
  // start server
  $.listen(process.env.PORT || 8080, (app) => {
    echo('Listening on ', app.location.href, '\n');

    /* istanbul ignore else */
    if (typeof done === 'function') {
      done($, app);
    }
  });
}

function _startApplication(done) {
  try {
    // reset context
    const Homegrown = homegrown();

    $ = Homegrown.new({
      env: process.env.NODE_ENV || 'dev',
      appDir: path.resolve(cwd, process.env.APP_DIR || 'app'),
      publicDir: path.resolve(cwd, process.env.PUBLIC_DIR || 'public'),
      session: {
        secret: process.env.SESSION_SECRET || 'secret*value',
        keys: (process.env.SESSION_KEYS || 'secret*value').split(/\s+/),
        maxAge: parseInt(process.env.SESSION_MAXAGE || 0, 10) || 86400000,
      },
      upload: {
        multiple: parseBool(process.env.UPLOAD_MULTIPLE) || true,
        maxFiles: parseInt(process.env.UPLOAD_MAXFILES, 0) || 10,
      },
      logger: {
        format: process.env.LOGGER_FORMAT || 'dev',
        colorize: parseBool(process.env.LOGGER_COLORIZE) || true,
      },
    });

    // import native support
    $.extensions('Homegrown.conn.http', () => require('http'));

    // log as soon as possible
    $.mount(require('morgan')($.get('logger.format')));

    // try static handler first
    $.mount(require('serve-static')($.get('publicDir')));

    // inject logging helpers
    $.use(homegrown.plugs.logger({
      transports: [{
        Console: {
          colorize: $.get('logger.colorize'),
        },
      }],
    }));

    // standard mvc kit
    $.use(homegrown.plugs.models($.get('appDir'), path.join(__dirname, '../lib/preset')));
    $.use(homegrown.plugs.render($.get('appDir'), path.join(__dirname, '../lib/preset')));
    $.use(homegrown.plugs.router($.get('appDir'), path.join(__dirname, '../lib/preset')));

    $.mount(require('body-parser').json());
    $.mount(require('body-parser').urlencoded({ extended: false }));

    // built-in method-override
    $.mount('_method', (conn) => {
      const _method = conn.query_params._method || conn.body_params._method
        || conn.req_headers['x-method-override']
        || conn.req_headers['x-http-method']
        || conn.req_headers['x-http-method-override'];

      /* istanbul ignore else */
      if (_method) {
        conn.req.originalMethod = conn.req.method;
        conn.req.method = _method.toUpperCase();

        // remove _method from query
        conn.req.url = conn.req.url
          .replace(/([&?])_method=\w+&?/g, '$1');

        // remove _method from body
        delete conn.req.body._method;
      }
    });

    $.use(homegrown.plugs.upload($.get('upload')));
    $.use(homegrown.plugs.session($.get('session')));

    /* istanbul ignore else */
    if (process.env.IS_REPL === 'true') {
      $.use(homegrown.plugs.repl({
        server: {
          help: 'Start the web server',
          action() {
            homegrown.burn(() => _startServer());
          },
        },
      }));

      $.emit('start').then(done);
    } else {
      _startServer(done);
    }
  } catch (e) {
    echo(`${e.stack || e.message || e.toString()}\n`);
    die(1);
  }
}

_startApplication();

function _reload(cb) {
  return homegrown.burn(() => {
    _clearModules();
    _startApplication(cb);
  });
}

if (process.env.IS_REPL === 'true') {
  process.on('repl:reload', () => _reload());
} else {
  process.on('exit', () => homegrown.burn());
  process.on('SIGINT', () => process.exit());
}

module.exports = cb => _reload(cb);
