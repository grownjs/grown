<!DOCTYPE html><html><head><base href="/"><meta lang="en"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="HandheldFriendly" content="true"><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no"><!--[if lt IE 9]><script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script><script src="//css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script><![endif]--><title>FTW</title><link rel="stylesheet" href="styles.css"><style>pre { overflow:auto }</style></head><body><main style="margin-left:20em;"><h2 id="booting">Booting</h2>
<p>About the <code>Grown.env/new/burn()</code> mechanism.</p>
<h3 id="server">Server</h3>
<p>Farms are created by instantiating application servers:</p>
<pre><code class="lang-js">const Grown = require(&#39;grown&#39;);

const cwd = process.cwd();

// initialize dot-env
Grown.env(cwd);

// a fresh farm
const $ = Grown.new({ cwd });
</code></pre>
<p>Callling <code>Grown.env()</code> is optional, but is there to help you loading <code>dot-env</code> settings.</p>
<p>If you don&#39;t pass a <code>cwd</code> value it will be taken from <code>process.cwd()</code> instead.</p>
<h3 id="api">API</h3>
<p>&mdash; Retrieve and option value by its keypath:</p>
<p><code>$.get(option[, default])</code></p>
<pre><code class="lang-js">const value = $.get(&#39;cwd&#39;);
const nestedValue = $.get(&#39;foo.bar&#39;);
const withDefaultValue = $.get(&#39;something&#39;, null);
</code></pre>
<p>If you don&#39;t provide a default value if the option is missing an exception will be thrown.</p>
<p>&mdash; Close the current server instance:</p>
<p><code>$.close([cb])</code></p>
<pre><code class="lang-js">$.close(() =&gt; process.exit(0));

// or
$.close().then(() =&gt; {
  process.exit(0);
});
</code></pre>
<p>&mdash; Starts the server connection:</p>
<p><code>$.listen([connection[, opts, [, cb]]])</code></p>
<p>Being called without arguments will use <code>http://0.0.0.0:80</code> as connection.</p>
<p>Otherwise connection should be a port-number, a full hostname, or even an object like:</p>
<pre><code class="lang-js">{
  protocol: &#39;https:&#39;,
  host: &#39;0.0.0.0:80&#39;,
  port: 80,
}
</code></pre>
<p>Additional options and callback will be passed as-is to any <code>createServer()</code> call afterwards.</p>
<h3 id="hooks">Hooks</h3>
<p>Farms has lifecycle events and hooks.</p>
<pre><code class="lang-js">// once you call $.run()
$.on(&#39;start&#39;, () =&gt; console.log(&#39;Starting application&#39;));

// once you call $.stop()
$.on(&#39;close&#39;, () =&gt; console.log(&#39;Closing application&#39;));

// once you call $.listen()
$.on(&#39;listen&#39;, () =&gt; console.log(&#39;Starting listener&#39;));
$.on(&#39;done&#39;, () =&gt; console.log(&#39;Listener ready&#39;));

// hooks from the REPL
$.on(&#39;repl&#39;, (repl, logger) =&gt; logger.ok(&#39;Hello CLI&#39;));
$.on(&#39;reload&#39;, (repl, logger) =&gt; logger.ok(&#39;Reloading...&#39;));
</code></pre>
<p>&mdash; Attach event listeners:</p>
<p><code>$.on(evt, cb)</code></p>
<pre><code class="lang-js">$.on(&#39;delay&#39;, ms =&gt;
  new Promise(resolve =&gt; {
    setTimeout(resolve, ms);
  }));
</code></pre>
<p>Event callbacks can return promises.</p>
<p>&mdash; Remove a single event listener:</p>
<p><code>$.off(evt, cb)</code></p>
<pre><code class="lang-js">const cb = () =&gt; 42;

$.on(&#39;truth&#39;, cb);
$.off(&#39;truth&#39;, cb);
</code></pre>
<p>&mdash; Attach event listener once:</p>
<p><code>$.once(evt, cb)</code></p>
<pre><code class="lang-js">$.once(&#39;reload&#39;, () =&gt; {
  console.log(&#39;Once and no more!&#39;);
});
</code></pre>
<p>&mdash; Emit event to its listeners:</p>
<p><code>$.emit(evt[, ...])</code></p>
<pre><code class="lang-js">$.emit(&#39;delay&#39;, 1000)
  .then(() =&gt; console.log(&#39;OK&#39;))
  .catch(() =&gt; console.log(&#39;FAIL&#39;));
</code></pre>
<p>Emitted events are returned as promises.</p>
<h3 id="plugins">Plugins</h3>
<p>Self-contained functionality can be plugged-in on your farms.</p>
<pre><code class="lang-js">$.use(ctx =&gt; {
  console.log($ === ctx); // true

  // enhance connection
  ctx.util.props({
    foo: Promise.resolve(42),
  })
  .then(result =&gt; {
    ctx.extensions.something = result;
  );
});
</code></pre>
<p>&mdash; Built-in plugs are:</p>
<ul>
<li><code>Grown.plugs.logger</code> &rarr; Add logging methods to the connection</li>
<li><code>Grown.plugs.models</code> &rarr; Support for look-up and loading models</li>
<li><code>Grown.plugs.render</code> &rarr; Support for views and layouts</li>
<li><code>Grown.plugs.router</code> &rarr; Support for app-routing</li>
<li><code>Grown.plugs.session</code> &rarr; Support for session and cookies</li>
<li><code>Grown.plugs.socket</code> &rarr; Support for SocketIO methods</li>
<li><code>Grown.plugs.testing</code> &rarr; Testing-wrapper harness</li>
<li><code>Grown.plugs.container</code> &rarr; Support for IoC/DI</li>
<li><code>Grown.plugs.formidable</code> &rarr; Support for file uploads</li>
</ul>
<h3 id="extensions">Extensions</h3>
<p>Plugins can and usually do enhance the <code>$.extensions</code> property.</p>
<p>&mdash; All those values are attached to the connection instance:</p>
<pre><code class="lang-js">$.mount(conn =&gt; {
  console.log(conn.something); // { foo: 42 }
});
</code></pre>
<h3 id="middlewares">Middlewares</h3>
<p>Functions that can manipulate the connection details.</p>
<pre><code class="lang-js">$.mount(conn =&gt; {
  console.log(&#39;Before all middleware is run&#39;);

  return conn.next(() =&gt; {
    console.log(&#39;After all middleware was run&#39;);
  });
});
</code></pre>
<p>&mdash; Express-middleware can be mounted too:</p>
<pre><code class="lang-js">$.mount(require(&#39;serve-static&#39;)(__dirname));
</code></pre>
<h3 id="testing-the-app">Testing the app</h3>
<p>You can leverage on <code>Grown.test()</code> for starting and adding hooks.</p>
<p>&mdash; So a typical test-harness may involve no configuration:</p>
<pre><code class="lang-coffee"># spec/app-spec.coffee

app = require(&#39;../app/server&#39;)
Grown = require(&#39;grown&#39;)

describe &#39;any application&#39;, -&gt;
  beforeEach Grown.test(app)

  it &#39;can be tested&#39;, (done) -&gt;
    # calling `Grown.test(app)` will return a function that:
    # - call `app.teardown()` to stop any previous instance
    # - setup a new `farm` by calling `app()`
    # - call `farm.run()`
    # - attach `farm.extensions` to `this`
    # - start listening at `test://`
    done()

  describe &#39;all extensions&#39;, -&gt;
    it &#39;can be tested too&#39;, (done) -&gt;
      # middleware and plugins can be loaded separatedly
      test = require(&#39;../boot/midlewares/test&#39;)
      result = null

      # assert or capture before
      @mount (conn) -&gt;
        null

      # mount before using
      @mount test()

      # assert or capture after
      @mount (conn) -&gt;
        result = conn.something_returned_by_middleware_test
        null

      # start requesting
      @server.fetch().then (res) -&gt;
        expect(result).toEqual { foo: 42 }
        done()

      .catch (error) -&gt;
        # capture in case of error
        console.log error
        done()
</code></pre>
<p>Depending on your needs you can go further.</p>
<h3 id="interactive-mode-reload">Interactive mode (reload)</h3>
<p>Reload all your code without restarting the whole process call <code>.reload</code> on the REPL.</p>
<p>&mdash; Closing the farm will also stop and teardown any hooked events:</p>
<pre><code class="lang-js">$.on(&#39;close&#39;, () =&gt; {
  console.log(&#39;All connections were properly closed?&#39;);
});
</code></pre>
<p>Be sure to listen <code>close</code> for cleanup anything else.</p>
<ul>
<li><a href="/">back</a></li>
<li><a href="/docs/assets">next</a></li>
</ul>
</main><aside style="position:fixed;top:0;max-width:20em;overflow:hidden;"><ul><li><a href="/">home</a></li><li><a href="/docs">docs</a><ul><li><a href="/docs/initialization">Initialization</a></li><li><a href="/docs/interactive-mode">Interactive mode</a></li><li><a href="/docs/controllers">Controllers</a><ul><li><a href="/docs/controllers#routing">Routing</a></li><li><a href="/docs/controllers#definition">Definition</a></li><li><a href="/docs/controllers#end-responses">End responses</a></li><li><a href="/docs/controllers#testing-actions">Testing actions</a></li><li><a href="/docs/controllers#interactive-mode-fetch">Interactive mode (fetch)</a></li></ul></li><li><a href="/docs/models">Models</a><ul><li><a href="/docs/models#json-schema">JSON-Schema</a></li><li><a href="/docs/models#model-syncing">Model syncing</a></li><li><a href="/docs/models#testing-models">Testing models</a></li><li><a href="/docs/models#interactive-mode-models">Interactive mode (models)</a></li></ul></li><li><a href="/docs/views">Views</a><ul><li><a href="/docs/views#functions-as-templates">Functions as templates</a></li><li><a href="/docs/views#pre-compiled-templates">Pre-compiled templates</a></li><li><a href="/docs/views#layouts-blocks">Layouts &amp; blocks</a></li><li><a href="/docs/views#testing-views">Testing views</a></li><li><a href="/docs/views#interactive-mode-render">Interactive mode (render)</a></li></ul></li><li><strong><a class="here" href="/docs/booting">Booting</a></strong><ul><li><a href="/docs/booting#server">Server</a></li><li><a href="/docs/booting#api">API</a></li><li><a href="/docs/booting#hooks">Hooks</a></li><li><a href="/docs/booting#plugins">Plugins</a></li><li><a href="/docs/booting#middlewares">Middlewares</a></li><li><a href="/docs/booting#testing-the-app">Testing the app</a></li><li><a href="/docs/booting#interactive-mode-reload">Interactive mode (reload)</a></li></ul></li><li><a href="/docs/assets">Assets</a><ul><li><a href="/docs/assets#static-files">Static files</a></li><li><a href="/docs/assets#javascripts">Javascripts</a></li><li><a href="/docs/assets#stylesheets">Stylesheets</a></li><li><a href="/docs/assets#images-sprites">Images &amp; Sprites</a></li><li><a href="/docs/assets#templating-views">Templating (views)</a></li></ul></li></ul></li></ul></aside></body></html>