<!DOCTYPE html>
<html>
  <head>
    <base href="/">
    <meta lang="en">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no"><!--[if lt IE 9]>
    <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <script src="https://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script><![endif]-->
    <title>Grown // Access (#7db424f)</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/highlight.js/styles/default.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Sorts+Mill+Goudy">
  </head>
  <body class="reset">
    <main id="wrapper">
      <div class="body" id="content">
        <main><a id="menu" href="./#sidebar">&#9776;</a>
          <h1>Access <small><a href="//github.com/grownjs/jamming/blob/master/src/pages/docs/extensions/access.md" target="_blank">✎</a></small></h1><p>Allow or deny access on certain resources from your application, e.g.</p>
<pre class="hljs"><code class="lang-js"><span class="hljs-comment">/* @runkit */</span>
<span class="hljs-comment">// register extension</span>
<span class="hljs-title class_">Grown</span>.<span class="hljs-title function_">use</span>(<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@grown/access&#x27;</span>));

<span class="hljs-comment">// overload definition</span>
<span class="hljs-title class_">Grown</span>(<span class="hljs-string">&#x27;Access&#x27;</span>, {
  <span class="hljs-attr">access_filter</span>: <span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> {
    <span class="hljs-comment">// retrieve role from the URL</span>
    <span class="hljs-keyword">const</span> matches = ctx.<span class="hljs-property">req</span>.<span class="hljs-property">url</span>.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/[&amp;?]role=(\w+)/</span>);

    <span class="hljs-keyword">if</span> (matches) {
      <span class="hljs-keyword">return</span> matches[<span class="hljs-number">1</span>];
    }
  },
});

<span class="hljs-comment">// setup rules</span>
server.<span class="hljs-title function_">plug</span>([
  <span class="hljs-title class_">Grown</span>.<span class="hljs-property">Access</span>.<span class="hljs-title function_">rules</span>({
    <span class="hljs-attr">roles</span>: [
      <span class="hljs-string">&#x27;Guest.User.Admin&#x27;</span>,
    ],
    <span class="hljs-attr">resources</span>: {
      <span class="hljs-comment">// this rule will block all requests</span>
      <span class="hljs-title class_">Website</span>: <span class="hljs-string">&#x27;/**&#x27;</span>,

      <span class="hljs-comment">// but only these requests will be allowed</span>
      <span class="hljs-title class_">Public</span>: <span class="hljs-regexp">/^\/(?:login|logout|public)/</span>,
    },
    <span class="hljs-attr">permissions</span>: {
      <span class="hljs-title class_">Website</span>: {
        <span class="hljs-comment">// User and its parents&#x27; roles get access too!</span>
        <span class="hljs-title class_">User</span>: <span class="hljs-string">&#x27;allow&#x27;</span>,
      },
      <span class="hljs-title class_">Public</span>: <span class="hljs-string">&#x27;allow&#x27;</span>,
    },
  }),
]);

<span class="hljs-comment">// once Access is plugged on the server</span>
<span class="hljs-comment">// all new middleware gets protected by default</span>
server.<span class="hljs-title function_">mount</span>(<span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> {
  ctx.<span class="hljs-property">res</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">&#x27;You are welcome!&#x27;</span>);

  <span class="hljs-comment">// validate against undefined rules</span>
  <span class="hljs-keyword">return</span> ctx.<span class="hljs-title function_">check</span>(<span class="hljs-string">&#x27;Foo&#x27;</span>, <span class="hljs-string">&#x27;Bar&#x27;</span>, <span class="hljs-string">&#x27;baz&#x27;</span>)
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
      ctx.<span class="hljs-property">res</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">&#x27;\nNot here...&#x27;</span>);
    });
});
</code></pre>
<blockquote>
<p>Click <kbd>► RUN</kbd> and try loading different URLs like <a href="/etc"><code>/etc</code></a> or <a href="/login"><code>/login</code></a> in your browser.</p>
</blockquote>
<div id="target"></div>

<hr>
<h3 id="methods-var-mixin-var">Methods <var>mixin</var></h3>
<ul>
<li><code>check(role, resource[, action])</code> &mdash; Validate given rules through the current connection, returns a promise.
If no <code>role</code> is given it&#39;ll try to call <code>access_filter</code> to retrieve one.</li>
</ul>
<h3 id="public-props-var-static-var">Public props <var>static</var></h3>
<ul>
<li><code>resources</code> &mdash; Collected resources from <code>rules</code> calls.</li>
<li><code>permissions</code> &mdash; Collected permissions from <code>rules</code> calls.</li>
</ul>
<h3 id="public-methods-var-static-var">Public methods <var>static</var></h3>
<ul>
<li><code>$install(ctx)</code> &mdash; Used by <code>server.plug</code> calls.</li>
<li><code>$mixins()</code> &mdash; Extra <code>Grown.Conn.Builder</code> definitions.</li>
<li><code>rules(config)</code> &mdash; Compile given <code>config</code> into access rules.</li>
</ul>
<h3 id="private-props-var-static-var">Private* props <var>static</var></h3>
<ul>
<li><code>_groups</code> &mdash; Graph from collected roles.</li>
<li><code>_ruleset</code> &mdash; Collection of compiled rules.</li>
</ul>
<h3 id="private-methods-var-static-var">Private* methods <var>static</var></h3>
<ul>
<li><code>_reduceHandler(handler, permissions)</code> &mdash; Check if <code>handler</code> exists within <code>permissions</code>, returns <code>null</code> otherwise.</li>
<li><code>_compileMatch(rule)</code> &mdash; Turns a single <code>rule</code> into a middleware callback.</li>
<li><code>_makeMatcher(ruleset)</code> &mdash; Iterates the given <code>ruleset</code> and compile each one. It returns a middleware callback.</li>
<li><code>_makeTree(role, groups, property)</code> &mdash; Returns a flat representation of the given <code>role</code> in the <code>groups</code> graph, <code>property</code> can be <code>children</code> or <code>parent</code>.</li>
<li><code>_runACL(ctx, role, handlers)</code> &mdash; Validate <code>role</code> access through <code>ctx</code>. Given <code>handlers</code> should be an array of single resources and actions. It returns a promise.</li>
</ul>
<hr>
<p>➯ Next: <a href="./docs/extensions/bud">Extensions &rangle; Bud</a></p>

        </main>
      </div>
      <aside class="inverted" id="sidebar">
        <div class="body">
          <h1>
            <a href=".">Grown</a>
          </h1>
          <p>Experimental DSL for web-apps</p>
          <div class="sp"><a href="http://badge.fury.io/js/grown" target="_blank"><img src="//badge.fury.io/js/grown.svg"></a><a href="//codecov.io/gh/grownjs/grown" target="_blank"><img src="//codecov.io/gh/grownjs/grown/branch/master/graph/badge.svg"></a><a href="//github.com/grownjs/grown/actions" target="_blank"><img src="//github.com/grownjs/grown/workflows/build/badge.svg"></a></div>
          <ul class="mt reset">
            <li>
              <h3 class="reset">APIs</h3>
              <ul class="pl reset">
                <li>
                  <a href=".">Installation</a>
                </li>
                <li>
                  <a aria-current="page" href="./docs">The interface</a>
                </li>
                <li>
                  <a href="./docs/command-line">Command line</a>
                </li>
              </ul>
            </li>
            <li>
              <h3 class="reset">Add-ons</h3>
              <ul class="pl reset">
                <li>
                  <a aria-current="page" href="./docs/extensions">Extensions</a>
                </li>
                <li>
                  <a href="./docs/connection">Connection</a>
                </li>
                <li>
                  <a href="./docs/middlewares">Middlewares</a>
                </li>
              </ul>
            </li>
            <li>
              <h3 class="reset">Data-layer</h3>
              <ul class="pl reset">
                <li>
                  <a href="./docs/database">Models</a>
                </li>
                <li>
                  <a href="./docs/validation">Schemas</a>
                </li>
              </ul>
            </li>
            <li>
              <h3 class="reset">Controllers</h3>
              <ul class="pl reset">
                <li>
                  <a href="./docs/controllers">Web</a>
                </li>
                <li>
                  <a href="./docs/controllers/grpc">GRPC</a>
                </li>
                <li>
                  <a href="./docs/controllers/graphql">GraphQL</a>
                </li>
              </ul>
            </li>
            <li>
              <h3 class="reset">Unit-testing</h3>
              <ul class="pl reset">
                <li>
                  <a href="./docs/testing">Server</a>
                </li>
                <li>
                  <a href="./docs/testing/schema">Schema</a>
                </li>
                <li>
                  <a href="./docs/testing/handlers">Handlers</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </aside>
    </main>
    <script>window.__runkit__ = {"endpoint":true,"preamble":{"contents":"const Grown = require('@grown/bud')();\n\nGrown.use(require('@grown/server'));\n\nconst server = new Grown();\n\nprocess.nextTick(() => server.listen(8080));\nprocess.stdout.write = msg => console.log(msg);\n"}};</script>
    <script src="//embed.runkit.com"></script>
    <script src="scripts.js"></script>
  </body>
</html>